<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakura Quest</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif; }
        .flashcard-container { perspective: 1000px; }
        .flashcard { width: 100%; height: 150px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .flashcard-front { background-color: white; border: 1px solid #FFD1DC; }
        .flashcard-back { background-color: #FFEDF1; transform: rotateY(180deg); }
        
        .celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .sakura-petal { position: absolute; width: 10px; height: 10px; background-color: #FFB7C5; border-radius: 50% 0; animation: fall 10s linear infinite; }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- D·ªÆ LI·ªÜU ƒê√É ƒê∆Ø·ª¢C N·∫†P S·∫¥N (PHI√äN B·∫¢N HO√ÄN CH·ªàNH CU·ªêI C√ôNG) ---
        const MOCK_MILESTONES = [
            // B√†i 1
            { id: 'n5_milestone_001', level: 'N5', order: 1, title: 'B√†i 1: Hiragana (A-K)', description: 'L√†m quen v·ªõi nh·ªØng con ch·ªØ m·ªÅm m·∫°i ƒë·∫ßu ti√™n.', xpReward: 50, sakuraPointReward: 5, vocabulary: [{ word: "„ÅÇ", reading: "a", meaning: "Ch·ªØ A" }, { word: "„ÅÑ", reading: "i", meaning: "Ch·ªØ I" }, { word: "„ÅÜ", reading: "u", meaning: "Ch·ªØ U" }, { word: "„Åà", reading: "e", meaning: "Ch·ªØ E" }, { word: "„Åä", reading: "o", meaning: "Ch·ªØ O" }, { word: "„Åã", reading: "ka", meaning: "Ch·ªØ Ka" }, { word: "„Åç", reading: "ki", meaning: "Ch·ªØ Ki" }, { word: "„Åè", reading: "ku", meaning: "Ch·ªØ Ku" }, { word: "„Åë", reading: "ke", meaning: "Ch·ªØ Ke" }, { word: "„Åì", reading: "ko", meaning: "Ch·ªØ Ko" }], 
              quiz: [
                { question: "Ch·ªØ '„ÅÑ' ƒë∆∞·ª£c ƒë·ªçc l√† g√¨?", options: ["a", "i", "u", "e"], answer: "i" }, 
                { question: "ƒê√¢u l√† ch·ªØ 'ka'?", options: ["„Åã", "„Åç", "„Åè", "„Åë"], answer: "„Åã" },
                { question: "Ch·ªØ '„Åä' ƒë∆∞·ª£c ƒë·ªçc l√† g√¨?", options: ["a", "e", "o", "u"], answer: "o" }, 
                { question: "ƒê√¢u l√† ch·ªØ '„Åè'?", options: ["„Åì", "„Åç", "„Åã", "„Åè"], answer: "„Åè" },
                { question: "Ch·ªØ '„Åà' ƒë·ªçc l√† g√¨?", options: ["„Åà", "„Åä", "„ÅÇ", "„ÅÑ"], answer: "„Åà"}, 
                { question: "ƒê√¢u l√† ch·ªØ '„Åì'?", options: ["„Åì", "„Åã", "„Åç", "„Åë"], answer: "„Åì" },
                { question: "Ch·ªØ '„ÅÇ' ƒë·ªçc l√† g√¨?", options: ["„Åä", "„ÅÇ", "„ÅÜ", "„Åà"], answer: "„ÅÇ" }, 
                { question: "Ch·ªØ '„Åç' ƒë·ªçc l√† g√¨?", options: ["„Åç", "„Åï", "„Å°", "„Å´"], answer: "„Åç"}, 
                { question: "ƒê√¢u l√† ch·ªØ '„ÅÜ'?", options: ["„ÅÇ", "„ÅÑ", "„ÅÜ", "„Åà"], answer: "„ÅÜ"}, 
                { question: "Ch·ªØ '„Åë' ƒë·ªçc l√† g√¨?", options: ["„Åë", "„Åõ", "„Å¶", "„Å≠"], answer: "„Åë"}, 
                { question: "Ch·ªØ g√¨ ƒë·ª©ng sau ch·ªØ '„Åã'?", options: ["„Åç", "„Åè", "„Åë", "„Åì"], answer: "„Åç"}
              ] 
            },
            { id: 'n5_milestone_002', level: 'N5', order: 2, title: 'B√†i 1: Gi·ªõi thi·ªáu b·∫£n th√¢n', description: 'H·ªçc m·∫´u c√¢u c∆° b·∫£n nh·∫•t ƒë·ªÉ gi·ªõi thi·ªáu m√¨nh l√† ai.', xpReward: 75, sakuraPointReward: 10, grammar: [{ structure: "A „ÅØ B „Åß„Åô„ÄÇ", explanation: "M·∫´u c√¢u kh·∫≥ng ƒë·ªãnh c∆° b·∫£n, c√≥ nghƒ©a l√† 'A l√† B'.", examples: ["„Çè„Åü„Åó „ÅØ „Éû„Ç§„ÇØ „Åß„Åô„ÄÇ(T√¥i l√† Mike.)"] }], vocabulary: [{ word: "„Çè„Åü„Åó", reading: "watashi", meaning: "T√¥i" }, { word: "„ÅÇ„Å™„Åü", reading: "anata", meaning: "B·∫°n" }, { word: "„Äú„Åß„Åô", reading: "desu", meaning: "L√†" }, { word: "„Åå„Åè„Åõ„ÅÑ", reading: "gakusei", meaning: "H·ªçc sinh" }], 
              quiz: [
                { question: "ƒê·ªÉ n√≥i 'T√¥i l√† h·ªçc sinh', b·∫°n d√πng c√¢u n√†o?", options: ["„Çè„Åü„Åó „ÅØ „Åå„Åè„Åõ„ÅÑ „Åß„Åô", "„ÅÇ„Å™„Åü „ÅØ „Åå„Åè„Åõ„ÅÑ „Åß„Åô", "„Åå„Åè„Åõ„ÅÑ „Çè„Åü„Åó „Åß„Åô"], answer: "„Çè„Åü„Åó „ÅØ „Åå„Åè„Åõ„ÅÑ „Åß„Åô" }, 
                { question: "'„Çè„Åü„Åó' c√≥ nghƒ©a l√† g√¨?", options: ["B·∫°n", "T√¥i", "Anh ·∫•y", "C√¥ ·∫•y"], answer: "T√¥i" }, 
                { question: "ƒêi·ªÅn v√†o ch·ªó tr·ªëng: „ÇÑ„Åæ„Å†„Åï„Çì „ÅØ „Åå„Åè„Åõ„ÅÑ ___„ÄÇ", options: ["„Åß„Åô", "„Åß„Åô„Åã", "„Åò„ÇÉ„ÅÇ„Çä„Åæ„Åõ„Çì"], answer: "„Åß„Åô" },
                { question: "'„Åå„Åè„Åõ„ÅÑ' c√≥ nghƒ©a l√† g√¨?", options: ["Gi√°o vi√™n", "H·ªçc sinh", "B√°c sƒ©", "K·ªπ s∆∞"], answer: "H·ªçc sinh" },
                { question: "C√¢u 'Tanaka l√† b√°c sƒ©' n√≥i th·∫ø n√†o?", options: ["„Åü„Å™„Åã„Åï„Çì„ÅØ „ÅÑ„Åó„ÇÉ„Åß„Åô", "„Åü„Å™„Åã„Åï„Çì„ÅØ „ÅÑ„Åó„ÇÉ„Åß„Åô„Åã", "„Åü„Å™„Åã„Åï„Çì„ÅØ „ÅÑ„Åó„ÇÉ„Åò„ÇÉ„ÅÇ„Çä„Åæ„Åõ„Çì"], answer: "„Åü„Å™„Åã„Åï„Çì„ÅØ „ÅÑ„Åó„ÇÉ„Åß„Åô" },
                { question: "Tr·ª£ t·ª´ n√†o d√πng ƒë·ªÉ nh·∫•n m·∫°nh ch·ªß ƒë·ªÅ c·ªßa c√¢u?", options: ["„ÅØ", "„Åå", "„Çí", "„ÇÇ"], answer: "„ÅØ" },
                { question: "D·∫°ng l·ªãch s·ª± c·ªßa 'l√†' trong ti·∫øng Nh·∫≠t l√† g√¨?", options: ["„Å†", "„Åß„Åô", "„Åß„ÅÇ„Çã"], answer: "„Åß„Åô" },
                { question: "Ch·ªçn c√¢u ƒë√∫ng ng·ªØ ph√°p:", options: ["„ÅÇ„Å™„Åü „Åß„Åô „Åå„Åè„Åõ„ÅÑ", "„Åå„Åè„Åõ„ÅÑ „Åß„Åô „ÅÇ„Å™„Åü", "„ÅÇ„Å™„Åü„ÅØ „Åå„Åè„Åõ„ÅÑ„Åß„Åô"], answer: "„ÅÇ„Å™„Åü„ÅØ „Åå„Åè„Åõ„ÅÑ„Åß„Åô" },
                { question: "'B·∫°n' trong ti·∫øng Nh·∫≠t l√† g√¨?", options: ["„Çè„Åü„Åó", "„Åã„Çå", "„Åã„ÅÆ„Åò„Çá", "„ÅÇ„Å™„Åü"], answer: "„ÅÇ„Å™„Åü" },
                { question: "C√¢u 'T√¥i l√† ng∆∞·ªùi Vi·ªát Nam' vi·∫øt th·∫ø n√†o?", options: ["„Çè„Åü„Åó„ÅØ „Éô„Éà„Éä„É†„Åò„Çì„Åß„Åô", "„ÅÇ„Å™„Åü„ÅØ „Éô„Éà„Éä„É†„Åò„Çì„Åß„Åô", "„Çè„Åü„Åó„ÅØ „Å´„Åª„Çì„Åò„Çì„Åß„Åô"], answer: "„Çè„Åü„Åó„ÅØ „Éô„Éà„Éä„É†„Åò„Çì„Åß„Åô" }
              ] 
            },
            ...Array.from({ length: 98 }, (_, i) => ({ id: `n5_milestone_${(i + 3).toString().padStart(3, '0')}`, level: 'N5', order: i + 3, title: `C·ªôt m·ªëc ${i + 3}`, description: `N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`, xpReward: 75, sakuraPointReward: 10, vocabulary: [], quiz: [] }))
        ];
        const MOCK_USER_PROGRESS = {id: 'user123', displayName: "An-san", avatarUrl: 'https://placehold.co/40x40/FFB7C5/5a3838?text=A', xp: 250, sakuraPoints: 1520, completedMilestones: ['n5_milestone_001'], currentMilestoneId: 'n5_milestone_002', purchasedItems: ['theme_dark'],};
        const MOCK_LEADERBOARD_DATA = [{ id: 'user001', displayName: 'Yuki', xp: 2340 }, { id: 'user007', displayName: 'Hana', xp: 1990 }, { id: 'user002', displayName: 'Hiroshi', xp: 1620 }, { id: 'user003', displayName: 'Sakura', xp: 1130 }, { id: 'user004', displayName: 'Kenji', xp: 880 }, { id: 'user123', displayName: 'An-san', xp: 250 }, { id: 'user005', displayName: 'Mai', xp: 120 }].map(u=>({...u, avatarUrl: `https://placehold.co/40x40/a2d2ff/ffffff?text=${u.displayName.charAt(0)}`}));
        const MOCK_SHOP_ITEMS = [{ id: 'theme_dark', name: 'Giao di·ªán ƒê√™m', price: 500, type: 'theme', icon: 'üåô' }, { id: 'theme_sakura', name: 'Giao di·ªán Sakura', price: 750, type: 'theme', icon: 'üå∏' }, { id: 'theme_ocean', name: 'Giao di·ªán Bi·ªÉn xanh', price: 750, type: 'theme', icon: 'üåä' }, { id: 'avatar_frame_gold', name: 'Khung V√†ng', price: 1000, type: 'avatar_frame', icon: 'üåü' }, { id: 'avatar_frame_fire', name: 'Khung L·ª≠a', price: 1200, type: 'avatar_frame', icon: 'üî•' }, { id: 'pack_n5_mock_test', name: 'G√≥i 5 ƒë·ªÅ thi th·ª≠ N5', price: 2000, type: 'test_pack', icon: 'üìù' }];
        const MOCK_CULTURAL_CHALLENGE = {
            id: 'challenge_culture_1', title: "Th·ª≠ th√°ch VƒÉn h√≥a Nh·∫≠t B·∫£n", xpReward: 150,
            quiz: [
                { question: "M√¥n v√µ truy·ªÅn th·ªëng c·ªßa Nh·∫≠t B·∫£n v·ªõi c√°c v√µ sƒ© c√≥ th√¢n h√¨nh to l·ªõn ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["Karate", "Judo", "Sumo", "Kendo"], answer: "Sumo" },
                { question: "Lo·∫°i c·ªïng ƒë·∫∑c tr∆∞ng th∆∞·ªùng th·∫•y ·ªü l·ªëi v√†o c√°c ƒë·ªÅn th·ªù Th·∫ßn ƒë·∫°o ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["R≈çmon", "Torii", "Mon", "Sammon"], answer: "Torii" },
                { question: "Th·ªß ƒë√¥ hi·ªán t·∫°i c·ªßa Nh·∫≠t B·∫£n l√† g√¨?", options: ["Kyoto", "Osaka", "Nara", "Tokyo"], answer: "Tokyo" },
                { question: "Trang ph·ª•c truy·ªÅn th·ªëng c·ªßa Nh·∫≠t B·∫£n l√† g√¨?", options: ["Hanbok", "Sari", "Kimono", "Ao Dai"], answer: "Kimono" },
                { question: "L·ªÖ h·ªôi ng·∫Øm hoa anh ƒë√†o v√†o m√πa xu√¢n ƒë∆∞·ª£c g·ªçi l√† g√¨?", options: ["Matsuri", "Hanami", "Obon", "Hinamatsuri"], answer: "Hanami" },
                { question: "M√≥n m√¨ l·∫°nh th∆∞·ªùng ƒë∆∞·ª£c ƒÉn v√†o m√πa h√® ·ªü Nh·∫≠t l√† g√¨?", options: ["Ramen", "Udon", "Soba", "Somen"], answer: "Somen" },
                { question: "Ng·ªçn n√∫i cao nh·∫•t Nh·∫≠t B·∫£n l√† ng·ªçn n√∫i n√†o?", options: ["N√∫i Kita", "N√∫i Ph√∫ Sƒ©", "N√∫i Aino", "N√∫i Yari"], answer: "N√∫i Ph√∫ Sƒ©" },
                { question: "T√™n c·ªßa lo·∫°i t√†u si√™u t·ªëc ·ªü Nh·∫≠t B·∫£n l√† g√¨?", options: ["Maglev", "Shinkansen", "JR Express", "Kintetsu"], answer: "Shinkansen" },
                { question: "Ngh·ªá thu·∫≠t g·∫•p gi·∫•y c·ªßa Nh·∫≠t B·∫£n c√≥ t√™n l√† g√¨?", options: ["Ikebana", "Shodo", "Origami", "Haiku"], answer: "Origami" },
                { question: "Ho√†ng ƒë·∫ø hi·ªán t·∫°i c·ªßa Nh·∫≠t B·∫£n c√≥ ni√™n hi·ªáu l√† g√¨?", options: ["Heisei", "Showa", "Reiwa", "Meiji"], answer: "Reiwa" }
            ]
        };
        const MOCK_GRAMMAR_PRACTICE = {
            id: 'grammar_practice_1', title: "Luy·ªán t·∫≠p Ng·ªØ ph√°p N5",
            questions: [
                { type: 'fill_in_the_blank', sentence: "„Çè„Åü„Åó __ „Éû„Ç§„ÇØ „Åß„Åô„ÄÇ", options: ["„ÅØ", "„Çí", "„Åå"], answer: "„ÅØ" },
                { type: 'fill_in_the_blank', sentence: "„Åì„Çå __ „Åª„Çì „Åß„Åô„Åã„ÄÇ", options: ["„ÇÇ", "„ÅØ", "„Å´"], answer: "„ÅØ" },
                { type: 'fill_in_the_blank', sentence: "„Éë„É≥ __ „Åü„Åπ„Åæ„Åô„ÄÇ", options: ["„Å∏", "„Çí", "„Åß"], answer: "„Çí" },
                { type: 'fill_in_the_blank', sentence: "„Åå„Å£„Åì„ÅÜ __ „ÅÑ„Åç„Åæ„Åô„ÄÇ", options: ["„Å®", "„Å∏", "„ÅÆ"], answer: "„Å∏" },
                { type: 'fill_in_the_blank', sentence: "„Éê„Çπ __ „Åç„Åæ„Åó„Åü„ÄÇ", options: ["„Åß", "„Å´", "„ÇÇ"], answer: "„Åß" },
                { type: 'fill_in_the_blank', sentence: "6„Åò __ „Åä„Åç„Åæ„Åô„ÄÇ", options: ["„Å´", "„Çí", "„Å®"], answer: "„Å´" },
                { type: 'fill_in_the_blank', sentence: "„Å®„ÇÇ„Å†„Å° __ „ÅÇ„ÅÑ„Åæ„Åô„ÄÇ", options: ["„Åß", "„Çí", "„Å´"], answer: "„Å´" },
                { type: 'fill_in_the_blank', sentence: "„Éá„Éë„Éº„Éà __ „Åã„ÅÑ„ÇÇ„ÅÆ„Çí„Åó„Åæ„Åô„ÄÇ", options: ["„Åß", "„Å´", "„Çí"], answer: "„Åß" },
                { type: 'fill_in_the_blank', sentence: "„ÅÇ„Å™„Åü __ „Åã„Å∞„Çì„ÅØ„Å©„Çå„Åß„Åô„Åã„ÄÇ", options: ["„Åå", "„ÇÇ", "„ÅÆ"], answer: "„ÅÆ" },
                { type: 'fill_in_the_blank', sentence: "„Åç„ÅÆ„ÅÜ„ÄÅ„Å™„Å´ __ „Åó„Åæ„Åó„Åü„Åã„ÄÇ", options: ["„Çí", "„Åã", "„Å´"], answer: "„Çí" },
            ]
        };
        const MOCK_KANJI_PRACTICE = {
            id: 'kanji_practice_1', title: "Luy·ªán t·∫≠p Kanji N5",
            questions: [
                { kanji: "Êó•Êú¨‰∫∫", options: ["„Å´„Åª„Çì„Åò„Çì", "„Å´„Å£„ÅΩ„Çì„Å≤„Å®", "„Å´„Åª„Çì„Å≤„Å®"], answer: "„Å´„Åª„Çì„Åò„Çì" },
                { kanji: "Â≠¶Áîü", options: ["„Åå„Åè„Åõ„ÅÑ", "„Åå„Åè„Åó„Çá„ÅÜ", "„Åå„Å£„Åõ„ÅÑ"], answer: "„Åå„Åè„Åõ„ÅÑ" },
                { kanji: "Êó•Êú¨Ë™û", options: ["„Å´„Åª„Çì„Åî", "„Å´„Å£„ÅΩ„Çì„Åî", "„Å´„Åª„Çì„ÇÇ„ÅÆ"], answer: "„Å´„Åª„Çì„Åî" },
                { kanji: "ÁÅ´ÊõúÊó•", options: ["„ÇÇ„Åè„Çà„ÅÜ„Å≥", "„Åô„ÅÑ„Çà„ÅÜ„Å≥", "„Åã„Çà„ÅÜ„Å≥"], answer: "„Åã„Çà„ÅÜ„Å≥" },
                { kanji: "Ê∞¥", options: ["„Åø„Åö", "„Å≤", "„Åç", "„Å§„Å°"], answer: "„Åø„Åö" },
                { kanji: "‰∏ÄÊúà", options: ["„ÅÑ„Å°„Åå„Å§", "„Å≤„Å®„Å§„Åç", "„Åã„Åö„Åç"], answer: "„ÅÑ„Å°„Åå„Å§" },
                { kanji: "‰ºöÁ§æÂì°", options: ["„Åã„ÅÑ„Åó„ÇÉ„ÅÑ„Çì", "„Åã„ÅÑ„Åó„ÇÉ„Åà„Çì", "„Åã„ÅÑ„Åó„ÇÉ„Å≤„Å®"], answer: "„Åã„ÅÑ„Åó„ÇÉ„ÅÑ„Çì" },
                { kanji: "ÂÖàÁîü", options: ["„Åõ„Çì„Åò„Çá„ÅÜ", "„Åõ„Çì„Åõ„ÅÑ", "„Åõ„Çì„Åó„Çá„ÅÜ"], answer: "„Åõ„Çì„Åõ„ÅÑ" },
                { kanji: "ÊØéÊó•", options: ["„Åæ„ÅÑ„Å≤", "„Åæ„ÅÑ„Åã", "„Åæ„ÅÑ„Å´„Å°"], answer: "„Åæ„ÅÑ„Å´„Å°" },
                { kanji: "ÊúàÊõúÊó•", options: ["„Åí„Å§„Çà„ÅÜ„Å≥", "„Å§„Åç„Çà„ÅÜ„Å≥", "„Åå„Å§„Çà„ÅÜ„Å≥"], answer: "„Åí„Å§„Çà„ÅÜ„Å≥" },
            ]
        };

        // --- STYLESHEET ---
        const styles = {
            container: { fontFamily: 'sans-serif', maxWidth: '600px', margin: 'auto', display: 'flex', flexDirection: 'column', height: '100vh', backgroundColor: '#FFF5F7', boxShadow: '0 0 10px rgba(0,0,0,0.1)' },
            mainContent: { flex: 1, overflowY: 'auto' },
            screen: { padding: 16, display: 'flex', flexDirection: 'column' },
            header: { padding: '16px 0', textAlign: 'center' },
            headerTitle: { fontSize: 24, fontWeight: 'bold', color: '#5a3838' },
            headerSubtitle: { fontSize: 16, color: '#6B7280', marginTop: 4 },
            contentArea: { flex: 1, justifyContent: 'center', textAlign: 'center' },
            primaryButton: { backgroundColor: '#FF6B8A', padding: 16, borderRadius: 12, textAlign: 'center', marginTop: 20, border: 'none', cursor: 'pointer', color: 'white', fontSize: 18, fontWeight: 'bold' },
            backButton: { marginBottom: 16, cursor: 'pointer', border: 'none', background: 'none', textAlign: 'left', padding: 0 },
            backButtonText: { color: '#FF6B8A', fontSize: 16 },
            roadmapPathContainer: { padding: '20px', position: 'relative' },
            roadmapPathLine: { position: 'absolute', top: 0, bottom: 0, left: '28px', width: '4px', backgroundColor: '#FFD1DC', zIndex: 1 },
            milestoneContainer: { display: 'flex', alignItems: 'flex-start', marginBottom: 20, position: 'relative', zIndex: 2 },
            milestoneIconContainer: { minWidth: 40, height: 40, borderRadius: '50%', display: 'flex', justifyContent: 'center', alignItems: 'center', marginRight: 15, zIndex: 1, border: '3px solid white' },
            milestoneIconText: { color: '#FFF', fontWeight: 'bold', fontSize: 18, margin: 0 },
            milestoneCard: { flex: 1, borderWidth: 2, borderStyle: 'solid', borderRadius: 12, padding: 16, backgroundColor: '#FFF' },
            milestoneTitle: { fontSize: 18, fontWeight: 'bold', margin: 0 },
            milestoneDescription: { fontSize: 14, marginTop: 4, margin: 0 },
            startButtonText: { color: '#FFF', fontWeight: 'bold' },
            reviewButton: { border: 'none', background: 'none', cursor: 'pointer', width: '100%', textAlign: 'left', padding: 0, marginTop: 8},
            reviewButtonText: { color: '#10B981', fontWeight: 'bold' },
            quizScreen: { padding: 16, display: 'flex', flexDirection: 'column', height: '100%', boxSizing: 'border-box' },
            quizProgressText: { textAlign: 'center', fontSize: 16, fontWeight: 'bold', color: '#5a3838', marginBottom: 20 },
            quizQuestionText: { fontSize: 22, fontWeight: '600', textAlign: 'center', marginBottom: 30 },
            kanjiQuestionText: { fontSize: 80, fontWeight: 'bold', textAlign: 'center', marginBottom: 20, color: '#374151', fontFamily: "'Yu Gothic', 'Meiryo', sans-serif" },
            quizOptionButton: { width: '100%', textAlign: 'center', backgroundColor: '#FFF', padding: 16, borderRadius: 12, borderWidth: 2, borderStyle: 'solid', borderColor: '#E5E7EB', marginBottom: 12, cursor: 'pointer', fontSize: 18 },
            correctAnswer: { backgroundColor: '#D1FAE5', borderColor: '#10B981' },
            incorrectAnswer: { backgroundColor: '#FEE2E2', borderColor: '#EF4444' },
            bottomNav: { display: 'flex', justifyContent: 'space-around', borderTop: '1px solid #E5E7EB', backgroundColor: '#FFF', padding: '8px 0' },
            navButton: { flex: 1, alignItems: 'center', border: 'none', background: 'none', cursor: 'pointer', padding: '4px 0' },
            navButtonText: { fontSize: 12, margin: 0, marginTop: 2 },
            practiceGrid: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, padding: '0 16px' },
            practiceCard: { backgroundColor: '#FFF', borderRadius: 12, padding: 20, textAlign: 'center', border: '1px solid #E5E7EB', cursor: 'pointer', transition: 'transform 0.2s ease-in-out' },
            practiceCardTitle: { fontSize: 16, fontWeight: 'bold', color: '#5a3838', margin: 0 },
            practiceCardSubtitle: { fontSize: 12, color: '#6B7280', marginTop: 4, margin: 0 },
            challengeCard: { gridColumn: '1 / -1', background: 'linear-gradient(45deg, #FF6B8A, #FFB7C5)', color: 'white', padding: 20, borderRadius: 12, textAlign: 'center', cursor: 'pointer', transition: 'transform 0.2s ease-in-out' },
            challengeTitle: { fontSize: 20, fontWeight: 'bold', margin: 0},
            challengeSubtitle: { margin: '4px 0 0 0', opacity: 0.9 },
            leaderboardList: { padding: '0 16px' },
            leaderboardItem: { display: 'flex', alignItems: 'center', padding: '12px', backgroundColor: '#FFF', borderRadius: 12, marginBottom: 8 },
            leaderboardRank: { fontSize: 16, fontWeight: 'bold', color: '#6B7280', width: 40 },
            leaderboardAvatar: { width: 40, height: 40, borderRadius: '50%', marginRight: 12 },
            leaderboardName: { flex: 1, fontSize: 16, fontWeight: '500', color: '#374151' },
            leaderboardXp: { fontSize: 16, fontWeight: 'bold', color: '#FF6B8A' },
            currentUserItem: { backgroundColor: '#FFEDF1', borderWidth: 2, borderStyle: 'solid', borderColor: '#FF6B8A' },
            shopHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 16px' },
            shopPoints: { backgroundColor: '#FFEDF1', color: '#FF6B8A', padding: '4px 12px', borderRadius: '99px', fontWeight: 'bold' },
            shopGrid: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, padding: '16px' },
            shopItem: { backgroundColor: '#FFF', borderRadius: 12, padding: 16, textAlign: 'center', border: '1px solid #E5E7EB' },
            shopItemIcon: { fontSize: 40, margin: '10px 0' },
            shopItemName: { fontWeight: 'bold', color: '#5a3838' },
            shopItemPrice: { display: 'flex', justifyContent: 'center', alignItems: 'center', fontWeight: 'bold', color: '#FF6B8A', marginTop: 8 },
            buyButton: { width: '100%', marginTop: 12, backgroundColor: '#FF6B8A', border: 'none', color: 'white', padding: '8px', borderRadius: 8, cursor: 'pointer' },
            ownedButton: { width: '100%', marginTop: 12, backgroundColor: '#10B981', border: 'none', color: 'white', padding: '8px', borderRadius: 8, cursor: 'not-allowed' },
        };

        // --- C√ÅC COMPONENT GIAO DI·ªÜN ---
        
        const Hoverable = ({ children, style }) => {const [hover, setHover] = useState(false); return (<div onMouseEnter={() => setHover(true)} onMouseLeave={() => setHover(false)} style={{...style, ...(hover ? {transform: 'scale(1.03)'} : {})}}>{children}</div>);};
        const Milestone = ({ milestone, state, onStart }) => { const isLocked = state === 'locked'; const isCompleted = state === 'completed'; const isCurrent = state === 'current'; const stateStylesDef = {completed: { iconBg: '#10B981', borderColor: '#10B981', textColor: '#065F46' }, current: { iconBg: '#FF6B8A', borderColor: '#FF6B8A', textColor: '#5a3838' }, locked: { iconBg: '#D1D5DB', borderColor: '#D1D5DB', textColor: '#9CA3AF' }}; const currentStyle = stateStylesDef[state]; return (<div style={styles.milestoneContainer}><div style={{...styles.milestoneIconContainer, backgroundColor: currentStyle.iconBg }}>{isCompleted && <p style={styles.milestoneIconText}>‚úì</p>}{isCurrent && <p style={styles.milestoneIconText}>‚ñ∂</p>}{isLocked && <p style={styles.milestoneIconText}>üîí</p>}</div><div style={{...styles.milestoneCard, borderColor: currentStyle.borderColor, backgroundColor: isLocked ? '#F9FAFB' : '#FFF' }}><p style={{...styles.milestoneTitle, color: currentStyle.textColor }}>{milestone.level} - {milestone.title}</p><p style={{...styles.milestoneDescription, color: isLocked ? '#9CA3AF' : '#6B7280' }}>{milestone.description}</p>{isCurrent && (<button style={{...styles.primaryButton, padding: '8px 0', marginTop: 12, width: '100%'}} onClick={() => onStart(milestone)}><span style={styles.startButtonText}>B·∫Øt ƒë·∫ßu</span></button>)}{isCompleted && (<button style={styles.reviewButton} onClick={() => onStart(milestone)}><span style={styles.reviewButtonText}>√în t·∫≠p</span></button>)}</div></div>);};
        const RoadmapScreen = ({ milestones, userProgress, onStartMilestone }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>L·ªô tr√¨nh H·ªçc t·∫≠p</h1></header><div style={styles.roadmapPathContainer}><div style={styles.roadmapPathLine} />{milestones.map(milestone => {let state = 'locked'; if (userProgress.completedMilestones.includes(milestone.id)) state = 'completed'; else if (userProgress.currentMilestoneId === milestone.id) state = 'current'; return <Milestone key={milestone.id} milestone={milestone} state={state} onStart={onStartMilestone} />})}</div></div>);
        const LearnScreen = ({ milestone, onStartQuiz, onBack }) => ( <div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><header style={styles.header}><h1 style={styles.headerTitle}>{milestone.title}</h1><p style={styles.headerSubtitle}>{milestone.description}</p></header><main style={styles.contentArea}><p>N·ªôi dung h·ªçc t·∫≠p s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y.</p></main><button style={styles.primaryButton} onClick={() => onStartQuiz(milestone)}>B·∫Øt ƒë·∫ßu Ki·ªÉm tra</button></div>);
        const QuizScreen = ({ quizData, onCompleteQuiz, onBack }) => { const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); const [score, setScore] = useState(0); const [selectedAnswer, setSelectedAnswer] = useState(null); const [isCorrect, setIsCorrect] = useState(null); const [quizSet, setQuizSet] = useState([]); const [timer, setTimer] = useState(5); const timerRef = useRef(null); useEffect(() => { const shuffleArray = (array) => { let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }; const quizPool = quizData.quiz || []; const randomizedQuiz = shuffleArray([...quizPool]).slice(0, 10); setQuizSet(randomizedQuiz); }, [quizData]); useEffect(() => { if (selectedAnswer) { clearInterval(timerRef.current); return; } setTimer(5); timerRef.current = setInterval(() => { setTimer(prev => prev - 1); }, 1000); return () => clearInterval(timerRef.current); }, [currentQuestionIndex, selectedAnswer]); useEffect(() => { if (timer === 0) { handleNext(); } }, [timer]); if (!quizData || !quizSet || quizSet.length === 0) { return <div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><main style={styles.contentArea}><p>Ch∆∞a c√≥ c√¢u h·ªèi cho c·ªôt m·ªëc n√†y.</p></main></div>;} const question = quizSet[currentQuestionIndex]; const handleAnswer = (option) => {if (selectedAnswer) return; const correct = option === question.answer; setSelectedAnswer(option); setIsCorrect(correct); if (correct) setScore(prev => prev + 1);}; const handleNext = () => {setSelectedAnswer(null); setIsCorrect(null); if (currentQuestionIndex < quizSet.length - 1) { setCurrentQuestionIndex(prev => prev + 1); } else { onCompleteQuiz(score, quizSet.length, quizData); }}; return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}><p style={styles.quizProgressText}>{`C√¢u ${currentQuestionIndex + 1} / ${quizSet.length}`}</p><p style={{...styles.quizProgressText, color: timer <= 2 ? 'red' : '#5a3838' }}>{`‚è≥ ${timer}s`}</p></div><main style={styles.contentArea}><h2 style={styles.quizQuestionText}>{question.question}</h2><div>{question.options.map(option => {let buttonStyle = {...styles.quizOptionButton}; if (selectedAnswer === option) buttonStyle = {...buttonStyle, ...(isCorrect ? styles.correctAnswer : styles.incorrectAnswer)}; else if (selectedAnswer && option === question.answer) buttonStyle = {...buttonStyle, ...styles.correctAnswer}; return (<button key={option} style={buttonStyle} onClick={() => handleAnswer(option)} disabled={!!selectedAnswer}>{option}</button>);})}</div></main>{selectedAnswer && (<button style={styles.primaryButton} onClick={handleNext}>{currentQuestionIndex < quizSet.length - 1 ? 'C√¢u ti·∫øp theo' : 'Ho√†n th√†nh'}</button>)}</div>);};
        const PracticeScreen = ({ onStartVocabPractice, onStartGrammarPractice, onStartKanjiPractice, onStartChallenge }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>Trung t√¢m Luy·ªán t·∫≠p</h1></header><div style={styles.practiceGrid}><Hoverable style={styles.challengeCard}><div onClick={onStartChallenge}><h3 style={styles.challengeTitle}>üî• Th·ª≠ th√°ch VƒÉn h√≥a</h3><p style={styles.challengeSubtitle}>Ki·ªÉm tra ki·∫øn th·ª©c v·ªÅ Nh·∫≠t B·∫£n!</p></div></Hoverable><Hoverable style={styles.practiceCard}><div onClick={onStartVocabPractice}><p style={styles.practiceCardTitle}>Luy·ªán T·ª´ v·ª±ng N5</p><p style={styles.practiceCardSubtitle}>√în t·∫≠p to√†n b·ªô</p></div></Hoverable><Hoverable style={styles.practiceCard}><div onClick={onStartGrammarPractice}><p style={styles.practiceCardTitle}>Luy·ªán Ng·ªØ ph√°p N5</p><p style={styles.practiceCardSubtitle}>ƒêi·ªÅn tr·ª£ t·ª´</p></div></Hoverable><Hoverable style={styles.practiceCard}><div onClick={onStartKanjiPractice}><p style={styles.practiceCardTitle}>Luy·ªán Kanji N5</p><p style={styles.practiceCardSubtitle}>Nh·∫≠n di·ªán H√°n t·ª±</p></div></Hoverable></div></div>);
        const VocabPracticeScreen = ({ vocabList, onBack }) => { const [currentIndex, setCurrentIndex] = useState(0); const cardRef = React.useRef(null); if (!vocabList || vocabList.length === 0) { return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><main style={styles.contentArea}><p>B·∫°n ch∆∞a h·ªçc t·ª´ v·ª±ng n√†o.</p></main></div>);} const currentVocab = vocabList[currentIndex]; const showNext = () => {if(cardRef.current) cardRef.current.classList.remove('is-flipped'); setCurrentIndex(prev => (prev + 1) % vocabList.length);}; return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><p style={styles.quizProgressText}>{`T·ª´ v·ª±ng ${currentIndex + 1} / ${vocabList.length}`}</p><main style={styles.contentArea}><div className="flashcard-container"><div className="flashcard" ref={cardRef} onClick={() => cardRef.current.classList.toggle('is-flipped')}><div className="flashcard-face flashcard-front"><h2 style={{fontSize: 36, fontWeight: 'bold'}}>{currentVocab.word}</h2></div><div className="flashcard-face flashcard-back"><p style={{fontSize: 24, fontWeight: '500'}}>{currentVocab.meaning}</p><p style={{fontSize: 18, color: '#6B7280'}}>({currentVocab.reading})</p></div></div></div></main><button style={styles.primaryButton} onClick={showNext}>T·ª´ ti·∫øp theo</button></div>);};
        const GrammarPracticeScreen = ({ quizData, onBack }) => { const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); const [selectedAnswer, setSelectedAnswer] = useState(null); const [isCorrect, setIsCorrect] = useState(null); const question = quizData.questions[currentQuestionIndex]; const sentenceParts = question.sentence.split('__'); const handleAnswer = (option) => { if(selectedAnswer) return; setIsCorrect(option === question.answer); setSelectedAnswer(option); }; const handleNext = () => { setSelectedAnswer(null); setIsCorrect(null); setCurrentQuestionIndex(prev => (prev + 1) % quizData.questions.length); }; return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><p style={styles.quizProgressText}>{`C√¢u ${currentQuestionIndex + 1} / ${quizData.questions.length}`}</p><main style={styles.contentArea}><div style={{...styles.quizQuestionText, fontSize: 28, display: 'flex', alignItems: 'center', justifyContent: 'center'}}><span>{sentenceParts[0]}</span><span style={{display: 'inline-block', width: 40, borderBottom: '2px solid black', margin: '0 8px'}}></span><span>{sentenceParts[1]}</span></div><div style={{marginTop: 30}}>{question.options.map(option => { let buttonStyle = {...styles.quizOptionButton}; if (selectedAnswer === option) { buttonStyle = {...buttonStyle, ...(isCorrect ? styles.correctAnswer : styles.incorrectAnswer)}; } else if (selectedAnswer && option === question.answer) { buttonStyle = {...buttonStyle, ...styles.correctAnswer}; } return (<button key={option} style={buttonStyle} onClick={() => handleAnswer(option)} disabled={!!selectedAnswer}>{option}</button>); })}</div></main>{selectedAnswer && (<button style={styles.primaryButton} onClick={handleNext}>C√¢u ti·∫øp theo</button>)}</div>);};
        const KanjiPracticeScreen = ({ quizData, onBack }) => { const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); const [selectedAnswer, setSelectedAnswer] = useState(null); const [isCorrect, setIsCorrect] = useState(null); const question = quizData.questions[currentQuestionIndex]; const handleAnswer = (option) => { if(selectedAnswer) return; setIsCorrect(option === question.answer); setSelectedAnswer(option); }; const handleNext = () => { setSelectedAnswer(null); setIsCorrect(null); setCurrentQuestionIndex(prev => (prev + 1) % quizData.questions.length); }; return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Tr·ªü v·ªÅ</span></button><p style={styles.quizProgressText}>{`C√¢u ${currentQuestionIndex + 1} / ${quizData.questions.length}`}</p><main style={styles.contentArea}><h2 style={styles.kanjiQuestionText}>{question.kanji}</h2><p>Ch·ªçn c√°ch ƒë·ªçc Hiragana ƒë√∫ng.</p><div style={{marginTop: 30}}>{question.options.map(option => { let buttonStyle = {...styles.quizOptionButton}; if (selectedAnswer === option) { buttonStyle = {...buttonStyle, ...(isCorrect ? styles.correctAnswer : styles.incorrectAnswer)}; } else if (selectedAnswer && option === question.answer) { buttonStyle = {...buttonStyle, ...styles.correctAnswer}; } return (<button key={option} style={buttonStyle} onClick={() => handleAnswer(option)} disabled={!!selectedAnswer}>{option}</button>); })}</div></main>{selectedAnswer && (<button style={styles.primaryButton} onClick={handleNext}>C√¢u ti·∫øp theo</button>)}</div>);};
        const LeaderboardScreen = ({ leaderboardData, currentUser }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>B·∫£ng x·∫øp h·∫°ng</h1></header><div style={styles.leaderboardList}>{leaderboardData.map((user, index) => (<div key={user.id} style={{...styles.leaderboardItem, ...(user.id === currentUser.id ? styles.currentUserItem : {})}}><span style={styles.leaderboardRank}>#{index + 1}</span><img src={user.avatarUrl} alt={user.displayName} style={styles.leaderboardAvatar} /><span style={styles.leaderboardName}>{user.displayName}</span><span style={styles.leaderboardXp}>{user.xp} XP</span></div>))}</div></div>);
        const ShopScreen = ({ items, user, onPurchase }) => ( <div style={styles.screen}><header style={{...styles.header, ...styles.shopHeader}}><h1 style={styles.headerTitle}>C·ª≠a h√†ng</h1><span style={styles.shopPoints}>üå∏ {user.sakuraPoints}</span></header><div style={styles.shopGrid}>{items.map(item => {const isOwned = user.purchasedItems.includes(item.id); const canAfford = user.sakuraPoints >= item.price; return (<div key={item.id} style={styles.shopItem}><div style={styles.shopItemIcon}>{item.icon}</div><p style={styles.shopItemName}>{item.name}</p><p style={styles.shopItemPrice}>üå∏ {item.price}</p>{isOwned ? (<button style={styles.ownedButton} disabled>ƒê√£ s·ªü h·ªØu</button>) : (<button style={{...styles.buyButton, opacity: canAfford ? 1 : 0.5}} disabled={!canAfford} onClick={() => onPurchase(item)}>Mua</button>)}</div>);})}</div></div>);
        const BottomNav = ({ activeTab, setActiveTab }) => {const NavButton = ({ tabName, label, icon }) => (<button onClick={() => setActiveTab(tabName)} style={styles.navButton}><span style={{color: activeTab === tabName ? '#FF6B8A' : '#6B7280', fontSize: 24}}>{icon}</span><p style={{...styles.navButtonText, color: activeTab === tabName ? '#FF6B8A' : '#6B7280', fontWeight: activeTab === tabName ? 'bold' : 'normal'}}>{label}</p></button>); return (<nav style={styles.bottomNav}><NavButton tabName="Roadmap" label="L·ªô tr√¨nh" icon="üó∫Ô∏è" /><NavButton tabName="Practice" label="Luy·ªán t·∫≠p" icon="üèãÔ∏è" /><NavButton tabName="Leaderboard" label="X·∫øp h·∫°ng" icon="üèÜ" /><NavButton tabName="Shop" label="C·ª≠a h√†ng" icon="üõçÔ∏è" /></nav>);};
        const CelebrationOverlay = () => { return <div className="celebration-overlay">{[...Array(50)].map((_, i) => <div key={i} className="sakura-petal" style={{left: `${Math.random() * 100}vw`, animationDelay: `${Math.random() * 10}s`, animationDuration: `${5 + Math.random() * 5}s`}}></div>)}</div>; };

        // --- COMPONENT APP CH√çNH ---
        function App() {
            const [isLoading, setIsLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('Roadmap');
            const [currentFlow, setCurrentFlow] = useState(null);
            const [milestones, setMilestones] = useState([]);
            const [userProgress, setUserProgress] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [shopItems, setShopItems] = useState([]);
            const [showCelebration, setShowCelebration] = useState(false);
            
            const learnedVocab = useMemo(() => { if (!userProgress || !milestones) return []; const completed = new Set(userProgress.completedMilestones); return milestones.filter(m => completed.has(m.id)).flatMap(m => m.vocabulary || []); }, [userProgress, milestones]);

            useEffect(() => {
                setMilestones(MOCK_MILESTONES);
                setUserProgress(MOCK_USER_PROGRESS);
                setLeaderboard(MOCK_LEADERBOARD_DATA);
                setShopItems(MOCK_SHOP_ITEMS);
                setIsLoading(false);
            }, []);
            
            const handleStartMilestone = (milestone) => setCurrentFlow({ screen: 'Learn', data: milestone });
            const handleStartQuiz = (milestone) => setCurrentFlow({ screen: 'Quiz', data: { ...milestone, type: 'milestone' } });
            const handleStartChallenge = () => setCurrentFlow({ screen: 'Quiz', data: { ...MOCK_CULTURAL_CHALLENGE, type: 'challenge' } });
            const handleStartVocabPractice = () => setCurrentFlow({ screen: 'VocabPractice' });
            const handleStartGrammarPractice = () => setCurrentFlow({ screen: 'GrammarPractice' });
            const handleStartKanjiPractice = () => setCurrentFlow({ screen: 'KanjiPractice' });
            const handleBackToMain = () => setCurrentFlow(null);
            
            const handleCompleteQuiz = (score, totalQuestions, quizData) => {
                const passingScore = Math.ceil(totalQuestions * 0.7); // ƒêi·ªÉm ƒë·ªó l√† 70%
                if (score >= passingScore) {
                    setShowCelebration(true);
                    setTimeout(() => setShowCelebration(false), 4000); // T·∫Øt hi·ªáu ·ª©ng sau 4s
                    alert(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${score}/${totalQuestions} c√¢u v√† ho√†n th√†nh ${quizData.title}!`);
                    
                    const updatedProgress = {...userProgress, xp: userProgress.xp + (quizData.xpReward || 0)};
                    
                    if (quizData.type === 'milestone' && !userProgress.completedMilestones.includes(quizData.id)) {
                        const nextMilestone = milestones.find(m => m.order === quizData.order + 1);
                        updatedProgress.sakuraPoints = userProgress.sakuraPoints + quizData.sakuraPointReward;
                        updatedProgress.completedMilestones = [...userProgress.completedMilestones, quizData.id];
                        updatedProgress.currentMilestoneId = nextMilestone ? nextMilestone.id : null;
                    }
                    setUserProgress(updatedProgress);
                } else {
                    alert(`R·∫•t ti·∫øc! B·∫°n ch·ªâ ƒë√∫ng ${score}/${totalQuestions} c√¢u. H√£y c·ªë g·∫Øng ƒë·∫°t ${passingScore}/${totalQuestions} c√¢u ƒë·ªÉ qua m·ªëc n√†y nh√©!`);
                }
                handleBackToMain();
            };

            const handlePurchaseItem = (item) => {
                if (userProgress.sakuraPoints < item.price) {
                    alert("B·∫°n kh√¥ng ƒë·ªß ƒêi·ªÉm Sakura!");
                    return;
                }
                setUserProgress(prev => ({...prev, sakuraPoints: prev.sakuraPoints - item.price, purchasedItems: [...prev.purchasedItems, item.id],}));
                alert(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ mua th√†nh c√¥ng ${item.name}.`);
            };

            if (isLoading) { return <p>ƒêang t·∫£i...</p>; }

            const renderContent = () => {
                if (currentFlow) {
                    switch (currentFlow.screen) {
                        case 'Learn': return <LearnScreen milestone={currentFlow.data} onStartQuiz={handleStartQuiz} onBack={handleBackToMain} />;
                        case 'Quiz': return <QuizScreen quizData={currentFlow.data} onCompleteQuiz={handleCompleteQuiz} onBack={handleBackToMain} />;
                        case 'VocabPractice': return <VocabPracticeScreen vocabList={learnedVocab} onBack={handleBackToMain} />;
                        case 'GrammarPractice': return <GrammarPracticeScreen quizData={MOCK_GRAMMAR_PRACTICE} onBack={handleBackToMain} />;
                        case 'KanjiPractice': return <KanjiPracticeScreen quizData={MOCK_KANJI_PRACTICE} onBack={handleBackToMain} />;
                        default: return null;
                    }
                }
                switch(activeTab) {
                    case 'Roadmap': return <RoadmapScreen milestones={milestones} userProgress={userProgress} onStartMilestone={handleStartMilestone} />;
                    case 'Practice': return <PracticeScreen onStartChallenge={handleStartChallenge} onStartVocabPractice={handleStartVocabPractice} onStartGrammarPractice={handleStartGrammarPractice} onStartKanjiPractice={handleStartKanjiPractice}/>;
                    case 'Leaderboard': return <LeaderboardScreen leaderboardData={leaderboard} currentUser={userProgress} />;
                    case 'Shop': return <ShopScreen items={shopItems} user={userProgress} onPurchase={handlePurchaseItem} />;
                    default: return <RoadmapScreen milestones={milestones} userProgress={userProgress} onStartMilestone={handleStartMilestone} />;
                }
            }

            return (
                <div style={styles.container}>
                    {showCelebration && <CelebrationOverlay />}
                    <main style={styles.mainContent}>
                        {renderContent()}
                    </main>
                    {!currentFlow && <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
